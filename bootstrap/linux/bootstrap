#!/usr/bin/env bash
set -euo pipefail

YP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source ${YP_DIR}/sh/common.inc.sh

[[ "${EUID}" != "0" ]] || {
    echo_err "Cannot bootstrap as root, primarily because homebrew cannot be running as root."
    exit 1
}

[[ "${YP_SKIP_SUDO_BOOTSTRAP:-}" = "true" ]] || \
    ${YP_DIR}/bootstrap/linux/bootstrap-sudo-${OS_RELEASE_ID}

source ${YP_DIR}/bootstrap/brew-util.inc.sh

echo_do "Print state info pre-homebrew..."
brew_system
brew_printenv
echo_done

[[ "${YP_SKIP_BREW_BOOTSTRAP:-}" = "true" ]] || \
    source ${YP_DIR}/bootstrap/brew-bootstrap.inc.sh

[[ "${CI:-}" != "true" ]] || {
    echo_do "Print state info pre-bootstrap..."
    brew_system
    brew_printenv
    echo_done

    source ${YP_DIR}/bootstrap/brew-install-ci.inc.sh
    hash -r
    source ${YP_DIR}/sh/common.inc.sh
}

source ${YP_DIR}/bootstrap/brew-bootstrap-brewfile.inc.sh

echo_do "Print state info post-bootstrap..."
brew_system
brew_printenv
brew_config
brew_list
echo_done

# see https://github.com/Homebrew/brew/issues/5013
hash -r
